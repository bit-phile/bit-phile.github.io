<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Docker Volume | bitPhile</title><meta name=keywords content="docker,infra,kubernetes,docker volume,volume,storage,bind mounts,tmpfs"><meta name=description content="Understanding Docker Volume Thoroughly Agenda Abstract Container layer and its data on docker host machine What are the flaws of storing data in the container layer? What is the solution? Using docker volume Conclusion Abstract A Docker container is an independent process comprising the application and its dependencies. Container has its processes, file system, and networks independent of the host machine.
Creating a resource in the running container stores that resource in the Read-Write layer or Container layer."><meta name=author content="Nitin"><link rel=canonical href=https://nitinsharmacs.github.io/tech/docker/docker-volume/><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://nitinsharmacs.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://nitinsharmacs.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://nitinsharmacs.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://nitinsharmacs.github.io/apple-touch-icon.png><link rel=mask-icon href=https://nitinsharmacs.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Docker Volume"><meta property="og:description" content="Understanding Docker Volume Thoroughly Agenda Abstract Container layer and its data on docker host machine What are the flaws of storing data in the container layer? What is the solution? Using docker volume Conclusion Abstract A Docker container is an independent process comprising the application and its dependencies. Container has its processes, file system, and networks independent of the host machine.
Creating a resource in the running container stores that resource in the Read-Write layer or Container layer."><meta property="og:type" content="article"><meta property="og:url" content="https://nitinsharmacs.github.io/tech/docker/docker-volume/"><meta property="og:image" content="https://nitinsharmacs.github.io/tech/docker/docker-volume.png"><meta property="article:section" content="tech"><meta property="article:published_time" content="2023-03-12T10:38:56+05:30"><meta property="article:modified_time" content="2023-03-12T10:38:56+05:30"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://nitinsharmacs.github.io/tech/docker/docker-volume.png"><meta name=twitter:title content="Docker Volume"><meta name=twitter:description content="Understanding Docker Volume Thoroughly Agenda Abstract Container layer and its data on docker host machine What are the flaws of storing data in the container layer? What is the solution? Using docker volume Conclusion Abstract A Docker container is an independent process comprising the application and its dependencies. Container has its processes, file system, and networks independent of the host machine.
Creating a resource in the running container stores that resource in the Read-Write layer or Container layer."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Teches","item":"https://nitinsharmacs.github.io/tech/"},{"@type":"ListItem","position":3,"name":"Docker Volume","item":"https://nitinsharmacs.github.io/tech/docker/docker-volume/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Docker Volume","name":"Docker Volume","description":"Understanding Docker Volume Thoroughly Agenda Abstract Container layer and its data on docker host machine What are the flaws of storing data in the container layer? What is the solution? Using docker volume Conclusion Abstract A Docker container is an independent process comprising the application and its dependencies. Container has its processes, file system, and networks independent of the host machine.\nCreating a resource in the running container stores that resource in the Read-Write layer or Container layer.","keywords":["docker","infra","kubernetes","docker volume","volume","storage","bind mounts","tmpfs"],"articleBody":"Understanding Docker Volume Thoroughly Agenda Abstract Container layer and its data on docker host machine What are the flaws of storing data in the container layer? What is the solution? Using docker volume Conclusion Abstract A Docker container is an independent process comprising the application and its dependencies. Container has its processes, file system, and networks independent of the host machine.\nCreating a resource in the running container stores that resource in the Read-Write layer or Container layer. This is a temporary storage mechanism. It is accessible until the container is running. Once the container is removed, all the data goes.\nDocker provides a few mechanisms to tackle this problem and volume is one of them. Let’s dig deeper into docker volumes.\nNote: All the examples are being done by using minikube for running docker daemon. Any mention of docker host machine refers to minikube node (You can go inside minikube node using, minikube ssh).\nContainer Layer I have explained about container layer in my previous post on Docker at Docker Image Layers. In this section, we would be seeing where actually the container layer is stored on the docker host machine. Excited? Seems like yes 😄. Let’s start.\nWhere does the container layer reside? Container layer is a read-write layer stacked on top of read-only image layers. We can’t modify read-only filesystem of read-only image layers. We can modify the contents in the file system of the container layer.\nLet’s spin up an alpine container with sh command.\ndocker run --rm -it alpine sh Creating a file as\n/ # echo \"Docker is awesome - Nitin\" \u003e testimonials.txt / # ls bin home mnt root srv tmp dev lib opt run sys usr etc media proc sbin testimonials.txt var Now, let’s see where this data is stored on the docker host machine.\nInspecting the above container of ID 385f23abffa3 gives the following\n$ docker inspect --format '{{ .GraphDriver.Data }}' 385f23abffa3 map[LowerDir:/var/lib/docker/overlay2/7cb62392ec2ace2c1ea07bbdee8c4976105f4f081531a29b7c5a0320aa5ae032-init/diff:/var/lib/docker/overlay2/71129bf0c1fb93d386d1abd9390e68eb08b64e65cb31186a0e710931359adb72/diff MergedDir:/var/lib/docker/overlay2/7cb62392ec2ace2c1ea07bbdee8c4976105f4f081531a29b7c5a0320aa5ae032/merged UpperDir:/var/lib/docker/overlay2/7cb62392ec2ace2c1ea07bbdee8c4976105f4f081531a29b7c5a0320aa5ae032/diff WorkDir:/var/lib/docker/overlay2/7cb62392ec2ace2c1ea07bbdee8c4976105f4f081531a29b7c5a0320aa5ae032/work] $ Woo! It gives a map with a bunch of paths. Let me example you each of these paths. The following descriptions are based on overlay2 storage driver.\nLowerDir is the read-only file system for lower image layers. Any changes made to the file system are reflected in the new file system of the read-write container layer. LowerDir acts as a base file system. UpperDir is the read-write file system for the container layer where we can create and delete files and directories. Container layer changes are stored in this location. MergedDir is the merge of LowerDir and UpperDir. It gives a unified view of the file system for the container. WorkDir is something overlay2 driver uses for its internal operations such as copy-on-write process. As you can see LowerDir has two paths separated by :.\nFirst one is the path of the lower image layer read-only file system.\n/var/lib/docker/overlay2/7cb62392ec2ace2c1ea07bbdee8c4976105f4f081531a29b7c5a0320aa5ae032-init/diff Second one is the path of the lower image layer read-only file system after changes made by previous running containers.\n/var/lib/docker/overlay2/71129bf0c1fb93d386d1abd9390e68eb08b64e65cb31186a0e710931359adb72/diff These two directories serve as a base read-only file system for the container layer read-write file system.\nAs we create a new file testimonials.txt in the container, let’s peek into UpperDir to see this new file. Remember, this is on the docker host machine.\n$ sudo ls -la /var/lib/docker/overlay2/7cb62392ec2ace2c1ea07bbdee8c4976105f4f081531a29b7c5a0320aa5ae032/diff total 16 drwxr-xr-x 3 root root 4096 Mar 12 06:45 . drwx--x--- 5 root root 4096 Mar 12 06:44 .. drwx------ 2 root root 4096 Mar 12 06:44 root -rw-r--r-- 1 root root 26 Mar 12 06:45 testimonials.txt $ Yay! We have testimonials.txt on our docker host machine. If we cat we see,\n$ pwd /var/lib/docker/overlay2/7cb62392ec2ace2c1ea07bbdee8c4976105f4f081531a29b7c5a0320aa5ae032/diff $ cat testimonials.txt Docker is awesome - Nitin Great. If you have noticed when we do ls inside the container, it gives more directories like,\n$:/ ls bin home mnt root srv tmp dev lib opt run sys usr etc media proc sbin testimonials.txt var However, we didn’t see these directories on UpperDir. Guess why?\nThe reason is, UpperDir only has the changes made to the container file system. This is where MergedDir comes into existence which provides a unified view of the file system. MergedDir is the merge of LowerDir and UpperDir to give a unified file system.\nLet’s see what is inside MergedDir.\n$ sudo ls /var/lib/docker/overlay2/7cb62392ec2ace2c1ea07bbdee8c4976105f4f081531a29b7c5a0320aa5ae032/merged bin etc lib mnt proc run srv testimonials.txt usr dev home media opt root sbin sys tmp var $ As we can see it is the same as the file system of the container. You can go ahead and try creating files in this location and see if it turns up in the container.\nThe Flaws of storing data in the container layer First thing first, storing data in the container layer is not permanent. Once you delete the container, all the data stored goes away.\nstorage-driver is getting used to dealing with the file system on the container. Using container file system for an IO-intensive application is always not a good idea. It causes performance issues and increases latency when accessing files stored on a container file system.\nContainer size gets increase when we start to store files on the container file system. I would give the example of a use case. Sometimes we get the need to create an image from the container itself. And if we have a huge amount of data inside the container, the resulting image would be big.\nSharing of data across containers is hard as it is highly coupled with the container itself.\nThese are the problems we are considering here. There may be different other problems.\nThen what is the solution, huh?\nSolution - Using Docker volume Volume is not the only solution. It is one of the solutions docker provides. Some other solutions are bind mound, tmpfs etc.\nWhat is Docker Volume? This is the way of storing and managing persistent data outside of container file system. It is stored on a host file system managed by Docker. These volumes can be shared across different containers.\nCool, Huh?\nLet’s create a volume Volumes are not tied to containers. So, we can create and manage volumes without even touching containers.\ndocker volume command is used to manage volumes.\n$ docker volume Usage: docker volume COMMAND Manage volumes Commands: create Create a volume inspect Display detailed information on one or more volumes ls List volumes prune Remove all unused local volumes rm Remove one or more volumes Run 'docker volume COMMAND --help' for more information on a command. $ Let’s create a volume of the name bitphile, 😁.\n$ docker volume create bitphile bitphile $ docker volume ls DRIVER VOLUME NAME local bitphile $ Inspecting this volume gives us,\n$ docker volume inspect bitphile [ { \"CreatedAt\": \"2023-03-12T07:38:38Z\", \"Driver\": \"local\", \"Labels\": {}, \"Mountpoint\": \"/var/lib/docker/volumes/bitphile/_data\", \"Name\": \"bitphile\", \"Options\": {}, \"Scope\": \"local\" } ] $ Mountpoint is where this volume is mounted. That is the location on the host machine where volume data will be stored.\nLet’s peek inside that location and see what’s there.\n$ sudo ls -la /var/lib/docker/volumes/bitphile/_data total 8 drwxr-xr-x 2 root root 4096 Mar 12 07:38 . drwx-----x 3 root root 4096 Mar 12 07:38 .. $ NOTHING? Well, we just created it 😂!\nMount Volume to container There are two methods of mounting volume to the container.\n--mount option -v option -v option is like shorthand. --mount is verbose and explicit, which is why we going to use --mount throughout this post.\nLet’s create a container and mount it to this volume we have just created.\n$ docker run --rm -it --mount type=volume,source=bitphile,target=/bitphile-vol alpine sh / # --mount option takes parameters are key=value pairs separated by ,.\ntype specifies the volume as type. --mount is being used by bind mounts, and tmpfs also. By default, type is volume. But for the sake of being explicit, I have used it. source is the volume name. target is the path in the container file system that will be mounted with the volume. There is alias of this option as dest, destination etc. Listing contents in the container file system root we see,\n/ # ls bin home opt sbin usr bitphile-vol lib proc srv var dev media root sys etc mnt run tmp / # We have bitphile-vol directory mounted to volume bitphile.\nLet’s create a file inside that directory.\n/ # echo Good morning \u003e bitphile-vol/greetings.txt / # cat bitphile-vol/greetings.txt Good morning / # Peeking on the volume mount location on the host machine, we see,\n$ sudo ls -la /var/lib/docker/volumes/bitphile/_data total 12 drwxr-xr-x 2 root root 4096 Mar 12 07:48 . drwx-----x 3 root root 4096 Mar 12 07:38 .. -rw-r--r-- 1 root root 13 Mar 12 07:48 greetings.txt $ Cool! We have greetings.txt.\nMount the same volume to another container Let’s spin up a new container with the same volume.\n$ docker run --name bitphile-second -it --mount source=bitphile,target=/bit-vol alpine sh / $ ls bin etc media proc sbin tmp bit-vol home mnt root srv usr dev lib opt run sys var / $ Let’s see what bit-vol has,\n/ # ls bit-vol greetings.txt / # cat bit-vol/greetings.txt Good morning / # Nice.\nConclusion Finally, we are at the end (the happiest moment when the zoom meeting ends 😂). So, docker volumes are used as one of the methods to store data permanently. There are some other methods of doing the same. We will have look at those sometime later.\nUntil then,\nReferences Docker Volumes ","wordCount":"1565","inLanguage":"en","image":"https://nitinsharmacs.github.io/tech/docker/docker-volume.png","datePublished":"2023-03-12T10:38:56+05:30","dateModified":"2023-03-12T10:38:56+05:30","author":{"@type":"Person","name":"Nitin"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://nitinsharmacs.github.io/tech/docker/docker-volume/"},"publisher":{"@type":"Organization","name":"bitPhile","logo":{"@type":"ImageObject","url":"https://nitinsharmacs.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://nitinsharmacs.github.io accesskey=h title="bitPhile (Alt + H)">bitPhile</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Docker Volume</h1><div class=post-meta><span title='2023-03-12 10:38:56 +0530 +0530'>March 12, 2023</span>&nbsp;·&nbsp;Nitin</div></header><figure class=entry-cover><img loading=lazy src=https://nitinsharmacs.github.io/tech/docker/docker-volume.png alt="Docker Volume Banner"></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#understanding-docker-volume-thoroughly aria-label="Understanding Docker Volume Thoroughly">Understanding Docker Volume Thoroughly</a><ul><li><a href=#agenda aria-label=Agenda>Agenda</a></li><li><a href=#abstract aria-label=Abstract>Abstract</a></li><li><a href=#container-layer aria-label="Container Layer">Container Layer</a><ul><li><a href=#where-does-the-container-layer-reside aria-label="Where does the container layer reside?">Where does the container layer reside?</a></li></ul></li><li><a href=#the-flaws-of-storing-data-in-the-container-layer aria-label="The Flaws of storing data in the container layer">The Flaws of storing data in the container layer</a></li><li><a href=#solution---using-docker-volume aria-label="Solution - Using Docker volume">Solution - Using Docker volume</a><ul><li><a href=#what-is-docker-volume aria-label="What is Docker Volume?">What is Docker Volume?</a></li><li><a href=#lets-create-a-volume aria-label="Let&amp;rsquo;s create a volume">Let&rsquo;s create a volume</a></li><li><a href=#mount-volume-to-container aria-label="Mount Volume to container">Mount Volume to container</a></li><li><a href=#mount-the-same-volume-to-another-container aria-label="Mount the same volume to another container">Mount the same volume to another container</a></li></ul></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li><li><a href=#references aria-label=References>References</a></li></ul></li></ul></div></details></div><div class=post-content><h1 id=understanding-docker-volume-thoroughly>Understanding Docker Volume Thoroughly<a hidden class=anchor aria-hidden=true href=#understanding-docker-volume-thoroughly>#</a></h1><h2 id=agenda>Agenda<a hidden class=anchor aria-hidden=true href=#agenda>#</a></h2><ol><li>Abstract</li><li>Container layer and its data on docker host machine</li><li>What are the flaws of storing data in the container layer?</li><li>What is the solution?</li><li>Using docker volume</li><li>Conclusion</li></ol><h2 id=abstract>Abstract<a hidden class=anchor aria-hidden=true href=#abstract>#</a></h2><p>A Docker container is an independent process comprising the application and its dependencies. Container has its processes, file system, and networks independent of the host machine.</p><p>Creating a resource in the running container stores that resource in the Read-Write layer or Container layer. This is a temporary storage mechanism. It is accessible until the container is running. Once the container is removed, all the data goes.</p><p>Docker provides a few mechanisms to tackle this problem and volume is one of them. Let&rsquo;s dig deeper into docker volumes.</p><blockquote><p>Note: All the examples are being done by using <code>minikube</code> for running docker daemon. Any mention of docker host machine refers to <code>minikube</code> node (You can go inside minikube node using, <code>minikube ssh</code>).</p></blockquote><h2 id=container-layer>Container Layer<a hidden class=anchor aria-hidden=true href=#container-layer>#</a></h2><p>I have explained about <strong>container layer</strong> in my previous post on Docker at <a href=/tech/docker/docker-image-layers>Docker Image Layers</a>. In this section, we would be seeing where actually the container layer is stored on the docker host machine. Excited? Seems like yes 😄. Let&rsquo;s start.</p><h3 id=where-does-the-container-layer-reside>Where does the container layer reside?<a hidden class=anchor aria-hidden=true href=#where-does-the-container-layer-reside>#</a></h3><p>Container layer is a read-write layer stacked on top of read-only image layers. We can&rsquo;t modify read-only filesystem of read-only image layers. We can modify the contents in the file system of the container layer.</p><p>Let&rsquo;s spin up an <code>alpine</code> container with <code>sh</code> command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run --rm -it alpine sh
</span></span></code></pre></div><p>Creating a file as</p><pre tabindex=0><code>/ # echo &#34;Docker is awesome - Nitin&#34; &gt; testimonials.txt
/ # ls
bin               home              mnt               root              srv               tmp
dev               lib               opt               run               sys               usr
etc               media             proc              sbin              testimonials.txt  var
</code></pre><p>Now, let&rsquo;s see where this data is stored on the docker host machine.</p><p>Inspecting the above container of ID <code>385f23abffa3</code> gives the following</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ docker inspect --format <span style=color:#e6db74>&#39;{{ .GraphDriver.Data }}&#39;</span> 385f23abffa3
</span></span><span style=display:flex><span>map<span style=color:#f92672>[</span>LowerDir:/var/lib/docker/overlay2/7cb62392ec2ace2c1ea07bbdee8c4976105f4f081531a29b7c5a0320aa5ae032-init/diff:/var/lib/docker/overlay2/71129bf0c1fb93d386d1abd9390e68eb08b64e65cb31186a0e710931359adb72/diff MergedDir:/var/lib/docker/overlay2/7cb62392ec2ace2c1ea07bbdee8c4976105f4f081531a29b7c5a0320aa5ae032/merged UpperDir:/var/lib/docker/overlay2/7cb62392ec2ace2c1ea07bbdee8c4976105f4f081531a29b7c5a0320aa5ae032/diff WorkDir:/var/lib/docker/overlay2/7cb62392ec2ace2c1ea07bbdee8c4976105f4f081531a29b7c5a0320aa5ae032/work<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>$
</span></span></code></pre></div><p>Woo! It gives a map with a bunch of paths. Let me example you each of these paths. The following descriptions are based on <code>overlay2</code> storage driver.</p><ol><li><code>LowerDir</code> is the read-only file system for lower image layers. Any changes made to the file system are reflected in the new file system of the read-write container layer. <code>LowerDir</code> acts as a base file system.</li><li><code>UpperDir</code> is the read-write file system for the container layer where we can create and delete files and directories. Container layer changes are stored in this location.</li><li><code>MergedDir</code> is the merge of <code>LowerDir</code> and <code>UpperDir</code>. It gives a unified view of the file system for the container.</li><li><code>WorkDir</code> is something <code>overlay2</code> driver uses for its internal operations such as copy-on-write process.</li></ol><p>As you can see <code>LowerDir</code> has two paths separated by <code>:</code>.</p><p>First one is the path of the lower image layer read-only file system.</p><pre tabindex=0><code>/var/lib/docker/overlay2/7cb62392ec2ace2c1ea07bbdee8c4976105f4f081531a29b7c5a0320aa5ae032-init/diff
</code></pre><p>Second one is the path of the lower image layer read-only file system after changes made by previous running containers.</p><pre tabindex=0><code>/var/lib/docker/overlay2/71129bf0c1fb93d386d1abd9390e68eb08b64e65cb31186a0e710931359adb72/diff
</code></pre><p>These two directories serve as a base read-only file system for the container layer read-write file system.</p><p>As we create a new file <code>testimonials.txt</code> in the container, let&rsquo;s peek into <code>UpperDir</code> to see this new file. Remember, this is on the docker host machine.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo ls -la /var/lib/docker/overlay2/7cb62392ec2ace2c1ea07bbdee8c4976105f4f081531a29b7c5a0320aa5ae032/diff
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span>drwxr-xr-x <span style=color:#ae81ff>3</span> root root <span style=color:#ae81ff>4096</span> Mar <span style=color:#ae81ff>12</span> 06:45 .
</span></span><span style=display:flex><span>drwx--x--- <span style=color:#ae81ff>5</span> root root <span style=color:#ae81ff>4096</span> Mar <span style=color:#ae81ff>12</span> 06:44 ..
</span></span><span style=display:flex><span>drwx------ <span style=color:#ae81ff>2</span> root root <span style=color:#ae81ff>4096</span> Mar <span style=color:#ae81ff>12</span> 06:44 root
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root   <span style=color:#ae81ff>26</span> Mar <span style=color:#ae81ff>12</span> 06:45 testimonials.txt
</span></span><span style=display:flex><span>$
</span></span></code></pre></div><p>Yay! We have <code>testimonials.txt</code> on our docker host machine. If we <code>cat</code> we see,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ pwd
</span></span><span style=display:flex><span>/var/lib/docker/overlay2/7cb62392ec2ace2c1ea07bbdee8c4976105f4f081531a29b7c5a0320aa5ae032/diff
</span></span><span style=display:flex><span>$ cat testimonials.txt
</span></span><span style=display:flex><span>Docker is awesome - Nitin
</span></span></code></pre></div><p>Great. If you have noticed when we do <code>ls</code> inside the container, it gives more directories like,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$:/ ls
</span></span><span style=display:flex><span>bin               home              mnt               root              srv               tmp
</span></span><span style=display:flex><span>dev               lib               opt               run               sys               usr
</span></span><span style=display:flex><span>etc               media             proc              sbin              testimonials.txt  var
</span></span></code></pre></div><p>However, we didn&rsquo;t see these directories on <code>UpperDir</code>. Guess why?</p><p>The reason is, <code>UpperDir</code> only has the changes made to the container file system. This is where <code>MergedDir</code> comes into existence which provides a unified view of the file system. <code>MergedDir</code> is the merge of <code>LowerDir</code> and <code>UpperDir</code> to give a unified file system.</p><p>Let&rsquo;s see what is inside <code>MergedDir</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo ls /var/lib/docker/overlay2/7cb62392ec2ace2c1ea07bbdee8c4976105f4f081531a29b7c5a0320aa5ae032/merged
</span></span><span style=display:flex><span>bin  etc   lib    mnt  proc  run   srv  testimonials.txt  usr
</span></span><span style=display:flex><span>dev  home  media  opt  root  sbin  sys  tmp               var
</span></span><span style=display:flex><span>$
</span></span></code></pre></div><p>As we can see it is the same as the file system of the container. You can go ahead and try creating files in this location and see if it turns up in the container.</p><h2 id=the-flaws-of-storing-data-in-the-container-layer>The Flaws of storing data in the container layer<a hidden class=anchor aria-hidden=true href=#the-flaws-of-storing-data-in-the-container-layer>#</a></h2><ol><li><p>First thing first, storing data in the container layer is not permanent. Once you delete the container, all the data stored goes away.</p></li><li><p><code>storage-driver</code> is getting used to dealing with the file system on the container. Using container file system for an IO-intensive application is always not a good idea. It causes performance issues and increases latency when accessing files stored on a container file system.</p></li><li><p>Container size gets increase when we start to store files on the container file system. I would give the example of a use case. Sometimes we get the need to create an image from the container itself. And if we have a huge amount of data inside the container, the resulting image would be big.</p></li><li><p>Sharing of data across containers is hard as it is highly coupled with the container itself.</p></li></ol><p>These are the problems we are considering here. There may be different other problems.</p><p>Then what is the solution, huh?</p><h2 id=solution---using-docker-volume>Solution - Using Docker volume<a hidden class=anchor aria-hidden=true href=#solution---using-docker-volume>#</a></h2><p>Volume is not the only solution. It is one of the solutions docker provides. Some other solutions are <code>bind mound</code>, <code>tmpfs</code> etc.</p><h3 id=what-is-docker-volume>What is Docker Volume?<a hidden class=anchor aria-hidden=true href=#what-is-docker-volume>#</a></h3><p>This is the way of storing and managing persistent data outside of container file system. It is stored on a host file system managed by Docker. These volumes can be shared across different containers.</p><p>Cool, Huh?</p><h3 id=lets-create-a-volume>Let&rsquo;s create a volume<a hidden class=anchor aria-hidden=true href=#lets-create-a-volume>#</a></h3><p>Volumes are not tied to containers. So, we can create and manage volumes without even touching containers.</p><p><code>docker volume</code> command is used to manage volumes.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ docker volume
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Usage:  docker volume COMMAND
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Manage volumes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Commands:
</span></span><span style=display:flex><span>  create      Create a volume
</span></span><span style=display:flex><span>  inspect     Display detailed information on one or more volumes
</span></span><span style=display:flex><span>  ls          List volumes
</span></span><span style=display:flex><span>  prune       Remove all unused local volumes
</span></span><span style=display:flex><span>  rm          Remove one or more volumes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Run <span style=color:#e6db74>&#39;docker volume COMMAND --help&#39;</span> <span style=color:#66d9ef>for</span> more information on a command.
</span></span><span style=display:flex><span>$
</span></span></code></pre></div><p>Let&rsquo;s create a volume of the name <code>bitphile</code>, 😁.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ docker volume create bitphile
</span></span><span style=display:flex><span>bitphile
</span></span><span style=display:flex><span>$ docker volume ls
</span></span><span style=display:flex><span>DRIVER    VOLUME NAME
</span></span><span style=display:flex><span>local     bitphile
</span></span><span style=display:flex><span>$
</span></span></code></pre></div><p>Inspecting this volume gives us,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ docker volume inspect bitphile
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;CreatedAt&#34;</span>: <span style=color:#e6db74>&#34;2023-03-12T07:38:38Z&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Driver&#34;</span>: <span style=color:#e6db74>&#34;local&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Labels&#34;</span>: <span style=color:#f92672>{}</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Mountpoint&#34;</span>: <span style=color:#e6db74>&#34;/var/lib/docker/volumes/bitphile/_data&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Name&#34;</span>: <span style=color:#e6db74>&#34;bitphile&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Options&#34;</span>: <span style=color:#f92672>{}</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Scope&#34;</span>: <span style=color:#e6db74>&#34;local&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>$
</span></span></code></pre></div><p><code>Mountpoint</code> is where this volume is mounted. That is the location on the host machine where volume data will be stored.</p><p>Let&rsquo;s peek inside that location and see what&rsquo;s there.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo ls -la /var/lib/docker/volumes/bitphile/_data
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>drwxr-xr-x <span style=color:#ae81ff>2</span> root root <span style=color:#ae81ff>4096</span> Mar <span style=color:#ae81ff>12</span> 07:38 .
</span></span><span style=display:flex><span>drwx-----x <span style=color:#ae81ff>3</span> root root <span style=color:#ae81ff>4096</span> Mar <span style=color:#ae81ff>12</span> 07:38 ..
</span></span><span style=display:flex><span>$
</span></span></code></pre></div><p>NOTHING? Well, we just created it 😂!</p><h3 id=mount-volume-to-container>Mount Volume to container<a hidden class=anchor aria-hidden=true href=#mount-volume-to-container>#</a></h3><p>There are two methods of mounting volume to the container.</p><ol><li><code>--mount</code> option</li><li><code>-v</code> option</li></ol><p><code>-v</code> option is like shorthand. <code>--mount</code> is verbose and explicit, which is why we going to use <code>--mount</code> throughout this post.</p><p>Let&rsquo;s create a container and mount it to this volume we have just created.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ docker run --rm -it --mount type<span style=color:#f92672>=</span>volume,source<span style=color:#f92672>=</span>bitphile,target<span style=color:#f92672>=</span>/bitphile-vol alpine sh
</span></span><span style=display:flex><span>/ <span style=color:#75715e>#</span>
</span></span></code></pre></div><p><code>--mount</code> option takes parameters are <code>key=value</code> pairs separated by <code>,</code>.</p><ul><li><code>type</code> specifies the <code>volume</code> as type. <code>--mount</code> is being used by <code>bind mounts</code>, and <code>tmpfs</code> also. By default, <code>type</code> is <code>volume</code>. But for the sake of being explicit, I have used it.</li><li><code>source</code> is the volume name.</li><li><code>target</code> is the path in the container file system that will be mounted with the volume. There is alias of this option as <code>dest</code>, <code>destination</code> etc.</li></ul><p>Listing contents in the container file system <code>root</code> we see,</p><pre tabindex=0><code>/ # ls
bin           home          opt           sbin          usr
bitphile-vol  lib           proc          srv           var
dev           media         root          sys
etc           mnt           run           tmp
/ #
</code></pre><p>We have <code>bitphile-vol</code> directory mounted to volume <code>bitphile</code>.</p><p>Let&rsquo;s create a file inside that directory.</p><pre tabindex=0><code>/ # echo Good morning &gt; bitphile-vol/greetings.txt
/ # cat bitphile-vol/greetings.txt
Good morning
/ #
</code></pre><p>Peeking on the volume mount location on the host machine, we see,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo ls -la /var/lib/docker/volumes/bitphile/_data
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>12</span>
</span></span><span style=display:flex><span>drwxr-xr-x <span style=color:#ae81ff>2</span> root root <span style=color:#ae81ff>4096</span> Mar <span style=color:#ae81ff>12</span> 07:48 .
</span></span><span style=display:flex><span>drwx-----x <span style=color:#ae81ff>3</span> root root <span style=color:#ae81ff>4096</span> Mar <span style=color:#ae81ff>12</span> 07:38 ..
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root   <span style=color:#ae81ff>13</span> Mar <span style=color:#ae81ff>12</span> 07:48 greetings.txt
</span></span><span style=display:flex><span>$
</span></span></code></pre></div><p>Cool! We have <code>greetings.txt</code>.</p><h3 id=mount-the-same-volume-to-another-container>Mount the same volume to another container<a hidden class=anchor aria-hidden=true href=#mount-the-same-volume-to-another-container>#</a></h3><p>Let&rsquo;s spin up a new container with the same volume.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ docker run --name bitphile-second -it --mount source<span style=color:#f92672>=</span>bitphile,target<span style=color:#f92672>=</span>/bit-vol alpine sh
</span></span><span style=display:flex><span>/ $ ls
</span></span><span style=display:flex><span>bin      etc      media    proc     sbin     tmp
</span></span><span style=display:flex><span>bit-vol  home     mnt      root     srv      usr
</span></span><span style=display:flex><span>dev      lib      opt      run      sys      var
</span></span><span style=display:flex><span>/ $
</span></span></code></pre></div><p>Let&rsquo;s see what <code>bit-vol</code> has,</p><pre tabindex=0><code>/ # ls bit-vol
greetings.txt
/ # cat bit-vol/greetings.txt
Good morning
/ #
</code></pre><p>Nice.</p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>Finally, we are at the end (the happiest moment when the zoom meeting ends 😂).
So, docker volumes are used as one of the methods to store data permanently. There are some other methods of doing the same. We will have look at those sometime later.</p><p>Until then,</p><p><img loading=lazy src=/bye-mr-bean.gif alt="Bye by Mr Bean" title="Bye bye, see you on next post"></p><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ol><li><a href=https://docs.docker.com/storage/volumes>Docker Volumes</a></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://nitinsharmacs.github.io/tags/docker/>docker</a></li><li><a href=https://nitinsharmacs.github.io/tags/infra/>infra</a></li><li><a href=https://nitinsharmacs.github.io/tags/kubernetes/>kubernetes</a></li><li><a href=https://nitinsharmacs.github.io/tags/docker-volume/>docker volume</a></li><li><a href=https://nitinsharmacs.github.io/tags/volume/>volume</a></li><li><a href=https://nitinsharmacs.github.io/tags/storage/>storage</a></li><li><a href=https://nitinsharmacs.github.io/tags/bind-mounts/>bind mounts</a></li><li><a href=https://nitinsharmacs.github.io/tags/tmpfs/>tmpfs</a></li></ul></footer><div id=commentor></div><script>const embedCommentorJs=()=>new Promise((e,t)=>{const n=document.createElement("script");n.setAttribute("defer",!0),n.src="/commentor/commentor.js",n.onload=e,n.onerror=t,document.head.appendChild(n)}),embedCommentorStyles=()=>new Promise((e,t)=>{const n=document.createElement("link");n.setAttribute("rel","stylesheet"),n.href="/commentor/commentor.css",n.onload=e,n.onerror=t,document.head.appendChild(n)}),getPageId=()=>window.location.href.split("/").slice(-2).join("");embedCommentorJs().then(()=>embedCommentorStyles()).then(()=>{Commentor&&Commentor.init("Comments",getPageId())}).catch(e=>console.error("Commentor not loaded",e))</script></article></main><footer class=footer><span>&copy; 2023 <a href=https://nitinsharmacs.github.io>bitPhile</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>