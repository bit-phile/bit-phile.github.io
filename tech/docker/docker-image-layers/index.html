<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Docker Image Layers | bitPhile</title><meta name=keywords content="docker,infra,kubernetes,docker image,image layers,image"><meta name=description content="Deep dive into Docker Image Layers In my previous post Getting started with docker, I explained the basics of docker. In this post, we will be deep diving into docker image layers. We will be covering the following topics in this post,
What are docker image layers? Why does knowing docker image layers matter? Where do these intermediary images reside and how to see them? What are the constituents of a docker container size?"><meta name=author content="Nitin"><link rel=canonical href=https://bit-phile.github.io/tech/docker/docker-image-layers/><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://bit-phile.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://bit-phile.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://bit-phile.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://bit-phile.github.io/apple-touch-icon.png><link rel=mask-icon href=https://bit-phile.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Docker Image Layers"><meta property="og:description" content="Deep dive into Docker Image Layers In my previous post Getting started with docker, I explained the basics of docker. In this post, we will be deep diving into docker image layers. We will be covering the following topics in this post,
What are docker image layers? Why does knowing docker image layers matter? Where do these intermediary images reside and how to see them? What are the constituents of a docker container size?"><meta property="og:type" content="article"><meta property="og:url" content="https://bit-phile.github.io/tech/docker/docker-image-layers/"><meta property="og:image" content="https://bit-phile.github.io/tech/docker/docker-image-layers-banner.png"><meta property="article:section" content="tech"><meta property="article:published_time" content="2023-03-05T13:00:22+05:30"><meta property="article:modified_time" content="2023-03-05T13:00:22+05:30"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://bit-phile.github.io/tech/docker/docker-image-layers-banner.png"><meta name=twitter:title content="Docker Image Layers"><meta name=twitter:description content="Deep dive into Docker Image Layers In my previous post Getting started with docker, I explained the basics of docker. In this post, we will be deep diving into docker image layers. We will be covering the following topics in this post,
What are docker image layers? Why does knowing docker image layers matter? Where do these intermediary images reside and how to see them? What are the constituents of a docker container size?"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Teches","item":"https://bit-phile.github.io/tech/"},{"@type":"ListItem","position":2,"name":"Docker Image Layers","item":"https://bit-phile.github.io/tech/docker/docker-image-layers/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Docker Image Layers","name":"Docker Image Layers","description":"Deep dive into Docker Image Layers In my previous post Getting started with docker, I explained the basics of docker. In this post, we will be deep diving into docker image layers. We will be covering the following topics in this post,\nWhat are docker image layers? Why does knowing docker image layers matter? Where do these intermediary images reside and how to see them? What are the constituents of a docker container size?","keywords":["docker","infra","kubernetes","docker image","image layers","image"],"articleBody":"Deep dive into Docker Image Layers In my previous post Getting started with docker, I explained the basics of docker. In this post, we will be deep diving into docker image layers. We will be covering the following topics in this post,\nWhat are docker image layers? Why does knowing docker image layers matter? Where do these intermediary images reside and how to see them? What are the constituents of a docker container size? Are you ready? Yes! So let’s start…\nWhat are docker image layers? When we build a docker image using Dockerfile, you must have seen the logs on the terminal console. There you must have seen some sha IDs that it shows. Those sha IDs are nothing but intermediary image layers IDs.\n⟩ docker build -f Dockerfile.new -t bitphile/test-image . (base) Sending build context to Docker daemon 7.168kB Step 1/4 : FROM alpine ---\u003e da7260331371 Step 2/4 : COPY app.sh ./app.sh ---\u003e 198fdf85c15b Step 3/4 : RUN chmod +x app.sh ---\u003e Running in cf5c357a3254 Removing intermediate container cf5c357a3254 ---\u003e 8e758ee45de3 Step 4/4 : ENTRYPOINT [\"./app.sh\"] ---\u003e Running in 857700b4b452 Removing intermediate container 857700b4b452 ---\u003e 4d85107b2c59 Successfully built 4d85107b2c59 Successfully tagged bitphile/test-image:latest A docker image is made up of several docker image layers. Each of the commands in Dockerfile stacks up a new image layer on top of the previous one.\nNote: Commands in Dockerfile are those instructions which do some changes in the file system. Any change made in the file system creates a new image layer. So, commands are responsible for the creation of a new image layer. For example, COPY, RUN, etc are commands.\nThe following image shows the docker image layers having ID and their corresponding parent layer ID.\nNote: Each of the layers coming on top of the existing one depends on their parent layer. Changing the sequence may altogether change the final image. Caching of image layers also depends upon this (upcoming sections).\nR/W image layers An image layer can be read-only or read and write. All the intermediate image layers are read-only. One can’t create a file in any of those layers. If anyone of you has worked on docker must be thinking, bitPhile is saying wrong as we can create files in running docker container.\nYour concern is right. We can create files in the docker container. The reason behind this is Container Layer which is explained in the next section.\nContainer Layer When an image is turned into a container, a new thin layer is stacked on top of the layers. This thin layer is called container layer. This image layer has both Read and Write access. All other image layers beneath this can only be read.\nSource: https://docs.docker.com/storage/storagedriver/images/container-layers.jpg\nWhy does knowing Image Layers matter? There are several reasons why one should know about docker image layers. A few of them are described below.\nImage Size An image is a pack of all dependencies, libraries, and src code required for an application. These images are stored on cloud registries and shared across devices. Size becomes a foremost requirement for an image.\nImage layers size consititute into the size of the final image. Identifying which layer is adding more size can help the developer to find areas of concern.\nLayers are Cached Image layers are stored on the host machine for future builds. This helps build docker images faster.\nLet’s see an example. Consider two Dockerfiles, Dockerfile.new-1 and Dockerfile.new-2.\nDockerfile.new-1\n# syntax=docker/dockerfile:1 FROM bitphile/my-base-image COPY app.sh ./app.sh RUN chmod +x app.sh ENTRYPOINT [\"./app.sh\"] Dockerfile.new-2\n# syntax=docker/dockerfile:1 FROM bitphile/my-base-image COPY app.sh ./app.sh Building the first image, the consoles show,\nSending build context to Docker daemon 7.168kB Step 1/4 : FROM bitphile/my-base-image ---\u003e da7260331379 Step 2/4 : COPY app.sh ./app.sh ---\u003e 198fdf85c15b Step 3/4 : RUN chmod +x app.sh ---\u003e Running in cf5c357a3254 Removing intermediate container cf5c357a3254 ---\u003e 8e758ee45de3 Step 4/4 : ENTRYPOINT [\"./app.sh\"] ---\u003e Running in 857700b4b452 Removing intermediate container 857700b4b452 ---\u003e 4d85107b2c59 Successfully built 4d85107b2c59 Successfully tagged bitphile/my-new-image:latest The second, it shows,\nSending build context to Docker daemon 8.192kB Step 1/2 : FROM bitphile/my-base-image ---\u003e da7260331379 Step 2/2 : COPY app.sh ./app.sh ---\u003e Using cache ---\u003e 198fdf85c15b Successfully built 198fdf85c15b Successfully tagged bitphile/my-new-image-2:latest We can see it uses caches for the second build. This increases the speed of building the image. Interesting, right?\nNote: If any instruction changes, caches are not used for the next instructions. New image layers are created for them from the scratch. Why does this happen? Think about it!\nSeeing Image Layers Once the final image is built, we can see intermediary image layers by,\ndocker history So, by running the above commands,\ndocker history bitphile/my-new-image Gives the output,\nIMAGE CREATED CREATED BY SIZE COMMENT 4d85107b2c59 50 minutes ago /bin/sh -c #(nop) ENTRYPOINT [\"./app.sh\"] 0B 8e758ee45de3 50 minutes ago /bin/sh -c chmod +x app.sh 33B 198fdf85c15b 50 minutes ago /bin/sh -c #(nop) COPY file:1179990b720068e4… 33B da7260331379 2 hours ago /bin/sh -c apk add --no-cache bash 2.24MB b2aa39c304c2 3 weeks ago /bin/sh -c #(nop) CMD [\"/bin/sh\"] 0B 3 weeks ago /bin/sh -c #(nop) ADD file:40887ab7c06977737… 7.05MB This shows the intermediate image ID, Dockerfile instruction, and size.\nNote: indicates that a particular image is built on a different machine or using builtKit docker builder.\nImage Layers on Machine We can find these image layers on the host machine at location /var/lib/docker. If you are using a virtual machine to run a docker daemon, ssh into that machine and access this location.\nListing the contents of /var/lib/docker gives,\ndrwx--x--x 4 root root 4.0K Feb 26 09:14 buildkit drwx--x--x 3 root root 4.0K Feb 26 09:14 containerd drwx--x--- 20 root root 4.0K Mar 5 05:51 containers drwx------ 3 root root 4.0K Dec 16 2021 image drwxr-x--- 3 root root 4.0K Feb 26 09:14 network drwx--x--- 173 root root 24K Mar 5 05:51 overlay2 drwx------ 4 root root 4.0K Feb 26 09:14 plugins drwx------ 2 root root 4.0K Mar 5 02:42 runtimes drwx------ 2 root root 4.0K Feb 26 09:14 swarm drwx------ 2 root root 4.0K Mar 5 06:21 tmp drwx------ 2 root root 4.0K Feb 26 09:14 trust drwx-----x 6 root root 4.0K Mar 5 02:42 volumes We can find these images in images//imagedb/content/sha25. In my case, overlay2 is storage driver. Refer my post Storage Driver.\nListing content of images/overlay2/imagedb/content/sha25, we see,\n-rw------- 1 root root 1.9K Mar 5 05:10 08bd868662db2cd09a4c7b8e74dad6a9c8fe186964ff31c65d335299d1324ff3 -rw------- 1 root root 1.9K Mar 5 05:51 198fdf85c15b292a5fff554f3afc26fd1824413822ddd75e72f08937889f1770 -rw------- 1 root root 2.2K Mar 5 05:11 1d17f325c607e937d89b19de66287aad351fc1abb80bc36591d34b7457ff8316 -rw------- 1 root root 1.7K Dec 16 2021 25f8c7f3da61c2a810effe5fa779cf80ca171afb0adf94c7cb51eb9a8546629d -rw------- 1 root root 16K Mar 1 12:49 2bc7edbc3cf2fce630a95d0586c48cd248e5df37df5b1244728a5c8c91becfe0 -rw------- 1 root root 2.4K Feb 26 09:51 2f6974482449313e863b0b709841b50da40ce7ef32017f0279671e9b2ee47289 -rw------- 1 root root 11K Mar 1 06:10 31d22a1554dfca7ad9377b67974ae2e0e3282247fc40fbf2ac3c380102ae772f -rw------- 1 root root 4.4K Mar 1 05:26 3c3a210148bab6bc3faedba72ad7de5e58a7cdb6bba0847965211f47fe1c4c21 -rw------- 1 root root 2.1K Feb 26 09:35 da7260331379a532a15cf3e9bff522627b1574a9ce21bb06c92cea74992613fa As you can see da7260331379 is used as a cache to build the image.\nDocker Container Size There are two things, size and virtual size.\nsize is the size of container layer. It comprises of all the files that are written container layer. virtual size is the sum of size and data of read-only intermediate image layers. If two containers have the same read-only intermediate image layers, will share the same data with separate container layer data. For example,\nCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES SIZE 7937d5f33e6e bitphile/my-new-image-2 \"./app.sh\" 5 seconds ago Up 5 seconds bitphile-test-container 0B (virtual 9.29MB) shows container bitphile-test-container has 0B size and 9.29MB virtual size. If you see the size of the whole image itself is 9.29MB which means it is all size of read-only image layer data.\nNow, adding a new file into the running container should increase the size.\ndocker exec 7937d5f33e6e sh -c \"echo hello world \u003e file.txt\" Now if we see the same container,\nCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES SIZE 7937d5f33e6e bitphile/my-new-image-2 \"./app.sh\" 39 seconds ago Up 39 seconds bitphile-test-container 11B (virtual 9.29MB) got 11B of size.\nSo, this is it for now. It’s great that you come reading till here. I will see you in my next post on docker. Till then,\nReferences Storage Drivers ","wordCount":"1345","inLanguage":"en","image":"https://bit-phile.github.io/tech/docker/docker-image-layers-banner.png","datePublished":"2023-03-05T13:00:22+05:30","dateModified":"2023-03-05T13:00:22+05:30","author":{"@type":"Person","name":"Nitin"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://bit-phile.github.io/tech/docker/docker-image-layers/"},"publisher":{"@type":"Organization","name":"bitPhile","logo":{"@type":"ImageObject","url":"https://bit-phile.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://bit-phile.github.io/ accesskey=h title="bitPhile (Alt + H)">bitPhile</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Docker Image Layers</h1><div class=post-meta><span title='2023-03-05 13:00:22 +0530 +0530'>March 5, 2023</span>&nbsp;·&nbsp;Nitin</div></header><figure class=entry-cover><img loading=lazy src=https://bit-phile.github.io/tech/docker/docker-image-layers-banner.png alt="Docker Image Layers Banner"></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#deep-dive-into-docker-image-layers aria-label="Deep dive into Docker Image Layers">Deep dive into Docker Image Layers</a><ul><li><a href=#what-are-docker-image-layers aria-label="What are docker image layers?">What are docker image layers?</a><ul><li><a href=#rw-image-layers aria-label="R/W image layers">R/W image layers</a></li><li><a href=#container-layer aria-label="Container Layer">Container Layer</a></li></ul></li><li><a href=#why-does-knowing-image-layers-matter aria-label="Why does knowing Image Layers matter?">Why does knowing Image Layers matter?</a><ul><li><a href=#image-size aria-label="Image Size">Image Size</a></li><li><a href=#layers-are-cached aria-label="Layers are Cached">Layers are Cached</a></li></ul></li><li><a href=#seeing-image-layers aria-label="Seeing Image Layers">Seeing Image Layers</a><ul><li><a href=#image-layers-on-machine aria-label="Image Layers on Machine">Image Layers on Machine</a></li></ul></li><li><a href=#docker-container-size aria-label="Docker Container Size">Docker Container Size</a></li><li><a href=#references aria-label=References>References</a></li></ul></li></ul></div></details></div><div class=post-content><h1 id=deep-dive-into-docker-image-layers>Deep dive into Docker Image Layers<a hidden class=anchor aria-hidden=true href=#deep-dive-into-docker-image-layers>#</a></h1><p>In my previous post <a href=/tech/docker/getting-started-with-docker>Getting started with docker</a>, I explained the basics of docker. In this post, we will be deep diving into docker image layers. We will be covering the following topics in this post,</p><ol><li>What are docker image layers?</li><li>Why does knowing docker image layers matter?</li><li>Where do these intermediary images reside and how to see them?</li><li>What are the constituents of a docker container size?</li></ol><p>Are you ready? Yes! So let&rsquo;s start&mldr;</p><h2 id=what-are-docker-image-layers>What are docker image layers?<a hidden class=anchor aria-hidden=true href=#what-are-docker-image-layers>#</a></h2><p>When we build a docker image using <code>Dockerfile</code>, you must have seen the logs on the terminal console. There you must have seen some <code>sha IDs</code> that it shows. Those <code>sha IDs</code> are nothing but intermediary image layers IDs.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>⟩ docker build -f Dockerfile.new -t bitphile/test-image .      <span style=color:#f92672>(</span>base<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Sending build context to Docker daemon  7.168kB
</span></span><span style=display:flex><span>Step 1/4 : FROM alpine
</span></span><span style=display:flex><span> ---&gt; da7260331371
</span></span><span style=display:flex><span>Step 2/4 : COPY app.sh ./app.sh
</span></span><span style=display:flex><span> ---&gt; 198fdf85c15b
</span></span><span style=display:flex><span>Step 3/4 : RUN chmod +x app.sh
</span></span><span style=display:flex><span> ---&gt; Running in cf5c357a3254
</span></span><span style=display:flex><span>Removing intermediate container cf5c357a3254
</span></span><span style=display:flex><span> ---&gt; 8e758ee45de3
</span></span><span style=display:flex><span>Step 4/4 : ENTRYPOINT <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;./app.sh&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span> ---&gt; Running in 857700b4b452
</span></span><span style=display:flex><span>Removing intermediate container 857700b4b452
</span></span><span style=display:flex><span> ---&gt; 4d85107b2c59
</span></span><span style=display:flex><span>Successfully built 4d85107b2c59
</span></span><span style=display:flex><span>Successfully tagged bitphile/test-image:latest
</span></span></code></pre></div><p>A docker image is made up of several docker image layers. Each of the commands in <code>Dockerfile</code> stacks up a new image layer on top of the previous one.</p><blockquote><p>Note: Commands in <code>Dockerfile</code> are those instructions which do some changes in the file system. Any change made in the file system creates a new image layer. So, commands are responsible for the creation of a new image layer.
For example, <code>COPY</code>, <code>RUN</code>, etc are commands.</p></blockquote><p>The following image shows the docker image layers having ID and their corresponding parent layer ID.</p><p><img loading=lazy src=/tech/docker/docker-image-layers.png alt=Docker-image-layers title="Docker image layers"></p><blockquote><p>Note: Each of the layers coming on top of the existing one depends on their parent layer. Changing the sequence may altogether change the final image. Caching of image layers also depends upon this (upcoming sections).</p></blockquote><h3 id=rw-image-layers>R/W image layers<a hidden class=anchor aria-hidden=true href=#rw-image-layers>#</a></h3><p>An image layer can be read-only or read and write. All the intermediate image layers are read-only. One can&rsquo;t create a file in any of those layers. If anyone of you has worked on docker must be thinking, <code>bitPhile</code> is saying wrong as we can create files in running docker container.</p><p>Your concern is right. We can create files in the docker container. The reason behind this is <code>Container Layer</code> which is explained in the next section.</p><h3 id=container-layer>Container Layer<a hidden class=anchor aria-hidden=true href=#container-layer>#</a></h3><p>When an image is turned into a container, a new thin layer is stacked on top of the layers. This thin layer is called <strong>container layer</strong>. This image layer has both Read and Write access. All other image layers beneath this can only be read.</p><p><img loading=lazy src=/tech/docker/container-layer.jpeg alt=thin-container-layer title="Container Layer">
Source: <a href=https://docs.docker.com/storage/storagedriver/images/container-layers.jpg>https://docs.docker.com/storage/storagedriver/images/container-layers.jpg</a></p><h2 id=why-does-knowing-image-layers-matter>Why does knowing Image Layers matter?<a hidden class=anchor aria-hidden=true href=#why-does-knowing-image-layers-matter>#</a></h2><p>There are several reasons why one should know about docker image layers. A few of them are described below.</p><h3 id=image-size>Image Size<a hidden class=anchor aria-hidden=true href=#image-size>#</a></h3><p>An image is a pack of all dependencies, libraries, and src code required for an application. These images are stored on cloud registries and shared across devices. Size becomes a foremost requirement for an image.</p><p>Image layers size consititute into the size of the final image. Identifying which layer is adding more size can help the developer to find areas of concern.</p><h3 id=layers-are-cached>Layers are Cached<a hidden class=anchor aria-hidden=true href=#layers-are-cached>#</a></h3><p>Image layers are stored on the host machine for future builds. This helps build docker images faster.</p><p>Let&rsquo;s see an example. Consider two Dockerfiles, <code>Dockerfile.new-1</code> and <code>Dockerfile.new-2</code>.</p><p><code>Dockerfile.new-1</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#75715e># syntax=docker/dockerfile:1</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> bitphile/my-base-image</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> app.sh ./app.sh<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> chmod +x app.sh<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;./app.sh&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p><code>Dockerfile.new-2</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#75715e># syntax=docker/dockerfile:1</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> bitphile/my-base-image</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> app.sh ./app.sh<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Building the first image, the consoles show,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Sending build context to Docker daemon  7.168kB
</span></span><span style=display:flex><span>Step 1/4 : FROM bitphile/my-base-image
</span></span><span style=display:flex><span> ---&gt; da7260331379
</span></span><span style=display:flex><span>Step 2/4 : COPY app.sh ./app.sh
</span></span><span style=display:flex><span> ---&gt; 198fdf85c15b
</span></span><span style=display:flex><span>Step 3/4 : RUN chmod +x app.sh
</span></span><span style=display:flex><span> ---&gt; Running in cf5c357a3254
</span></span><span style=display:flex><span>Removing intermediate container cf5c357a3254
</span></span><span style=display:flex><span> ---&gt; 8e758ee45de3
</span></span><span style=display:flex><span>Step 4/4 : ENTRYPOINT <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;./app.sh&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span> ---&gt; Running in 857700b4b452
</span></span><span style=display:flex><span>Removing intermediate container 857700b4b452
</span></span><span style=display:flex><span> ---&gt; 4d85107b2c59
</span></span><span style=display:flex><span>Successfully built 4d85107b2c59
</span></span><span style=display:flex><span>Successfully tagged bitphile/my-new-image:latest
</span></span></code></pre></div><p>The second, it shows,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Sending build context to Docker daemon  8.192kB
</span></span><span style=display:flex><span>Step 1/2 : FROM bitphile/my-base-image
</span></span><span style=display:flex><span> ---&gt; da7260331379
</span></span><span style=display:flex><span>Step 2/2 : COPY app.sh ./app.sh
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; 198fdf85c15b
</span></span><span style=display:flex><span>Successfully built 198fdf85c15b
</span></span><span style=display:flex><span>Successfully tagged bitphile/my-new-image-2:latest
</span></span></code></pre></div><p>We can see it uses caches for the second build. This increases the speed of building the image. Interesting, right?</p><blockquote><p>Note: If any instruction changes, caches are not used for the next instructions. New image layers are created for them from the scratch. Why does this happen? Think about it!</p></blockquote><h2 id=seeing-image-layers>Seeing Image Layers<a hidden class=anchor aria-hidden=true href=#seeing-image-layers>#</a></h2><p>Once the final image is built, we can see intermediary image layers by,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker history &lt;image-name&gt;
</span></span></code></pre></div><p>So, by running the above commands,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker history bitphile/my-new-image
</span></span></code></pre></div><p>Gives the output,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>IMAGE          CREATED          CREATED BY                                      SIZE      COMMENT
</span></span><span style=display:flex><span>4d85107b2c59   <span style=color:#ae81ff>50</span> minutes ago   /bin/sh -c <span style=color:#75715e>#(nop)  ENTRYPOINT [&#34;./app.sh&#34;]      0B</span>
</span></span><span style=display:flex><span>8e758ee45de3   <span style=color:#ae81ff>50</span> minutes ago   /bin/sh -c chmod +x app.sh                      33B
</span></span><span style=display:flex><span>198fdf85c15b   <span style=color:#ae81ff>50</span> minutes ago   /bin/sh -c <span style=color:#75715e>#(nop) COPY file:1179990b720068e4…   33B</span>
</span></span><span style=display:flex><span>da7260331379   <span style=color:#ae81ff>2</span> hours ago      /bin/sh -c apk add --no-cache bash              2.24MB
</span></span><span style=display:flex><span>b2aa39c304c2   <span style=color:#ae81ff>3</span> weeks ago      /bin/sh -c <span style=color:#75715e>#(nop)  CMD [&#34;/bin/sh&#34;]              0B</span>
</span></span><span style=display:flex><span>&lt;missing&gt;      <span style=color:#ae81ff>3</span> weeks ago      /bin/sh -c <span style=color:#75715e>#(nop) ADD file:40887ab7c06977737…   7.05MB</span>
</span></span></code></pre></div><p>This shows the intermediate image ID, Dockerfile instruction, and size.</p><blockquote><p>Note: <code>&lt;missing></code> indicates that a particular image is built on a different machine or using <a href=https://docs.docker.com/build/buildkit/><code>builtKit</code></a> docker builder.</p></blockquote><h3 id=image-layers-on-machine>Image Layers on Machine<a hidden class=anchor aria-hidden=true href=#image-layers-on-machine>#</a></h3><p>We can find these image layers on the host machine at location <code>/var/lib/docker</code>. If you are using a virtual machine to run a docker daemon, ssh into that machine and access this location.</p><p>Listing the contents of <code>/var/lib/docker</code> gives,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>drwx--x--x   <span style=color:#ae81ff>4</span> root root 4.0K Feb <span style=color:#ae81ff>26</span> 09:14 buildkit
</span></span><span style=display:flex><span>drwx--x--x   <span style=color:#ae81ff>3</span> root root 4.0K Feb <span style=color:#ae81ff>26</span> 09:14 containerd
</span></span><span style=display:flex><span>drwx--x---  <span style=color:#ae81ff>20</span> root root 4.0K Mar  <span style=color:#ae81ff>5</span> 05:51 containers
</span></span><span style=display:flex><span>drwx------   <span style=color:#ae81ff>3</span> root root 4.0K Dec <span style=color:#ae81ff>16</span>  <span style=color:#ae81ff>2021</span> image
</span></span><span style=display:flex><span>drwxr-x---   <span style=color:#ae81ff>3</span> root root 4.0K Feb <span style=color:#ae81ff>26</span> 09:14 network
</span></span><span style=display:flex><span>drwx--x--- <span style=color:#ae81ff>173</span> root root  24K Mar  <span style=color:#ae81ff>5</span> 05:51 overlay2
</span></span><span style=display:flex><span>drwx------   <span style=color:#ae81ff>4</span> root root 4.0K Feb <span style=color:#ae81ff>26</span> 09:14 plugins
</span></span><span style=display:flex><span>drwx------   <span style=color:#ae81ff>2</span> root root 4.0K Mar  <span style=color:#ae81ff>5</span> 02:42 runtimes
</span></span><span style=display:flex><span>drwx------   <span style=color:#ae81ff>2</span> root root 4.0K Feb <span style=color:#ae81ff>26</span> 09:14 swarm
</span></span><span style=display:flex><span>drwx------   <span style=color:#ae81ff>2</span> root root 4.0K Mar  <span style=color:#ae81ff>5</span> 06:21 tmp
</span></span><span style=display:flex><span>drwx------   <span style=color:#ae81ff>2</span> root root 4.0K Feb <span style=color:#ae81ff>26</span> 09:14 trust
</span></span><span style=display:flex><span>drwx-----x   <span style=color:#ae81ff>6</span> root root 4.0K Mar  <span style=color:#ae81ff>5</span> 02:42 volumes
</span></span></code></pre></div><p>We can find these images in <code>images/&lt;storage-driver-name>/imagedb/content/sha25</code>. In my case, <code>overlay2</code> is storage driver. Refer my post <a href=/tech/docker/docker-storage-driver>Storage Driver</a>.</p><p>Listing content of <code>images/overlay2/imagedb/content/sha25</code>, we see,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> root root 1.9K Mar  <span style=color:#ae81ff>5</span> 05:10 08bd868662db2cd09a4c7b8e74dad6a9c8fe186964ff31c65d335299d1324ff3
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> root root 1.9K Mar  <span style=color:#ae81ff>5</span> 05:51 198fdf85c15b292a5fff554f3afc26fd1824413822ddd75e72f08937889f1770
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> root root 2.2K Mar  <span style=color:#ae81ff>5</span> 05:11 1d17f325c607e937d89b19de66287aad351fc1abb80bc36591d34b7457ff8316
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> root root 1.7K Dec <span style=color:#ae81ff>16</span>  <span style=color:#ae81ff>2021</span> 25f8c7f3da61c2a810effe5fa779cf80ca171afb0adf94c7cb51eb9a8546629d
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> root root  16K Mar  <span style=color:#ae81ff>1</span> 12:49 2bc7edbc3cf2fce630a95d0586c48cd248e5df37df5b1244728a5c8c91becfe0
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> root root 2.4K Feb <span style=color:#ae81ff>26</span> 09:51 2f6974482449313e863b0b709841b50da40ce7ef32017f0279671e9b2ee47289
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> root root  11K Mar  <span style=color:#ae81ff>1</span> 06:10 31d22a1554dfca7ad9377b67974ae2e0e3282247fc40fbf2ac3c380102ae772f
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> root root 4.4K Mar  <span style=color:#ae81ff>1</span> 05:26 3c3a210148bab6bc3faedba72ad7de5e58a7cdb6bba0847965211f47fe1c4c21
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> root root 2.1K Feb <span style=color:#ae81ff>26</span> 09:35 da7260331379a532a15cf3e9bff522627b1574a9ce21bb06c92cea74992613fa
</span></span></code></pre></div><p>As you can see <code>da7260331379</code> is used as a cache to build the image.</p><h2 id=docker-container-size>Docker Container Size<a hidden class=anchor aria-hidden=true href=#docker-container-size>#</a></h2><p>There are two things, <code>size</code> and <code>virtual size</code>.</p><ul><li><code>size</code> is the size of <code>container layer</code>. It comprises of all the files that are written <code>container layer</code>.</li></ul><ul><li><code>virtual size</code> is the sum of <code>size</code> and data of read-only intermediate image layers. If two containers have the same read-only intermediate image layers, will share the same data with separate <code>container layer</code> data.</li></ul><p>For example,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>CONTAINER ID   IMAGE                                          COMMAND                  CREATED         STATUS                   PORTS                  NAMES                                                                                                         SIZE
</span></span><span style=display:flex><span>7937d5f33e6e   bitphile/my-new-image-2                        <span style=color:#e6db74>&#34;./app.sh&#34;</span>               <span style=color:#ae81ff>5</span> seconds ago   Up <span style=color:#ae81ff>5</span> seconds                                    bitphile-test-container                                                                                       0B <span style=color:#f92672>(</span>virtual 9.29MB<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>shows container <code>bitphile-test-container</code> has <code>0B</code> <code>size</code> and <code>9.29MB</code> <code>virtual size</code>. If you see the size of the whole image itself is <code>9.29MB</code> which means it is all size of read-only image layer data.</p><p>Now, adding a new file into the running container should increase the <code>size</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker exec 7937d5f33e6e sh -c <span style=color:#e6db74>&#34;echo hello world &gt; file.txt&#34;</span>
</span></span></code></pre></div><p>Now if we see the same container,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>CONTAINER ID   IMAGE                                          COMMAND                  CREATED          STATUS                   PORTS                  NAMES                                                                                                         SIZE
</span></span><span style=display:flex><span>7937d5f33e6e   bitphile/my-new-image-2                        <span style=color:#e6db74>&#34;./app.sh&#34;</span>               <span style=color:#ae81ff>39</span> seconds ago   Up <span style=color:#ae81ff>39</span> seconds                                   bitphile-test-container                                                                                       11B <span style=color:#f92672>(</span>virtual 9.29MB<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>got <code>11B</code> of <code>size</code>.</p><p>So, this is it for now. It&rsquo;s great that you come reading till here. I will see you in my next post on docker. Till then,</p><p><img loading=lazy src=/bye-mr-bean.gif alt="Bye by Mr Bean" title="Bye bye, see you on next post"></p><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ol><li><a href=https://docs.docker.com/storage/storagedriver/#the-copy-on-write-cow-strategy>Storage Drivers</a></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://bit-phile.github.io/tags/docker/>docker</a></li><li><a href=https://bit-phile.github.io/tags/infra/>infra</a></li><li><a href=https://bit-phile.github.io/tags/kubernetes/>kubernetes</a></li><li><a href=https://bit-phile.github.io/tags/docker-image/>docker image</a></li><li><a href=https://bit-phile.github.io/tags/image-layers/>image layers</a></li><li><a href=https://bit-phile.github.io/tags/image/>image</a></li></ul></footer><div id=commentor></div><script>const embedCommentorJs=()=>new Promise((e,t)=>{const n=document.createElement("script");n.setAttribute("defer",!0),n.src="/commentor/commentor.js",n.onload=e,n.onerror=t,document.head.appendChild(n)}),embedCommentorStyles=()=>new Promise((e,t)=>{const n=document.createElement("link");n.setAttribute("rel","stylesheet"),n.href="/commentor/commentor.css",n.onload=e,n.onerror=t,document.head.appendChild(n)}),getPageId=()=>window.location.href.split("/").slice(-2).join("");embedCommentorJs().then(()=>embedCommentorStyles()).then(()=>{Commentor&&Commentor.init("Comments",getPageId())}).catch(e=>console.error("Commentor not loaded",e))</script></article></main><footer class=footer><span>&copy; 2023 <a href=https://bit-phile.github.io/>bitPhile</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>